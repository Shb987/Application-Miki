<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="d-flex">

  <!-- Sidebar -->
  <div class="bg-dark text-white p-3" style="width:250px; min-height:100vh;">
    <h4>Admin Panel</h4>
    <ul class="list-unstyled">
      <li><a href="#" class="text-white" onclick="loadStudents()">ðŸ“˜ Student Data</a></li>
      <li><a href="#" class="text-white" onclick="loadUsers()">ðŸ‘¤ User Data</a></li>
      <li><a href="#" class="text-white" onclick="loadLogins()">ðŸ”‘ Login Data</a></li>
      <li><a href="#" class="text-danger" onclick="logout()">ðŸšª Logout</a></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="flex-grow-1 p-4">
    <h2>Welcome, <span id="admin-name">Admin</span></h2>
    <hr>
    <div id="data-section">
      <p>Select an option from the menu.</p>
    </div>
  </div>

  <script>
    const API_BASE = "http://127.0.0.1:8000";
    const token = localStorage.getItem("access_token");

    // âœ… Redirect if not logged in
    if (!token) {
      window.location.href = "/admin-panel/login";
    }

    // âœ… Load Admin Profile
    async function loadAdminProfile() {
      try {
        const res = await fetch(`${API_BASE}/admin/get_details`, {
          headers: { "Authorization": "Bearer " + token }
        });

        if (!res.ok) {
          localStorage.removeItem("access_token");
          window.location.href = "/admin-panel/login";
          return;
        }

        const data = await res.json();
        document.getElementById("admin-name").innerText = data.username;
      } catch (err) {
        console.error("Error loading profile:", err);
      }
    }

    // âœ… Generic table renderer
    function displayTable(items, title, columns) {
      let html = `<h3>${title}</h3>`;
      if (items.length === 0) {
        html += "<p>No data available</p>";
      } else {
        html += `<table class="table table-bordered table-striped">
          <thead><tr>`;
        columns.forEach(col => {
          html += `<th>${col.label}</th>`;
        });
        html += `</tr></thead><tbody>`;

        items.forEach(item => {
          html += "<tr>";
          columns.forEach(col => {
            let value = item[col.key] ?? "";
            if (col.key.includes("created_at") || col.key.includes("expiry")) {
              value = new Date(value).toLocaleString();
            }
            if (Array.isArray(value)) {
              value = value.join(", ");
            }
            html += `<td>${value}</td>`;
          });
          html += "</tr>";
        });

        html += "</tbody></table>";
      }
      document.getElementById("data-section").innerHTML = html;
    }

    // âœ… Load Students
    async function loadStudents() {
      const res = await fetch(`${API_BASE}/user/students`, {
        headers: { "Authorization": "Bearer " + token }
      });
      const data = await res.json();
      displayTable(data.students || [], "Students", [
        { key: "student_id", label: "Student ID" },
        { key: "student_name", label: "Name" },
        { key: "dob", label: "DOB" },
        { key: "student_class", label: "Class" },
        { key: "guardian_name", label: "Guardian" },
        { key: "address", label: "Address" },
        { key: "created_at", label: "Created At" },
        { key: "is_user", label: "Is User" }
      ]);
    }

    // âœ… Load Users
    async function loadUsers() {
      const res = await fetch(`${API_BASE}/user/users`, {
        headers: { "Authorization": "Bearer " + token }
      });
      const data = await res.json();
      displayTable(data.users || [], "Users", [
        { key: "mobile_number", label: "Mobile" },
        { key: "usertype", label: "User Type" },
        { key: "student_ids", label: "Student IDs" },
        { key: "created_at", label: "Created At" }
      ]);
    }

    // âœ… Load Logins
    async function loadLogins() {
      const res = await fetch(`${API_BASE}/user/logins`, {
        headers: { "Authorization": "Bearer " + token }
      });
      const data = await res.json();
      displayTable(data.logins || [], "Logins", [
        { key: "mobile_number", label: "Mobile" },
        { key: "otp", label: "OTP" },
        { key: "usertype", label: "User Type" },
        { key: "created_at", label: "Created At" },
        { key: "expiry", label: "Expiry" }
      ]);
    }

    // âœ… Logout
    function logout() {
      localStorage.removeItem("access_token");
      window.location.href = "/admin-panel/login";
    }

    // Run profile loader
    loadAdminProfile();
  </script>

</body>
</html>
